version: '3.8'

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        RUBY_VERSION: 3.4.7
    image: portfolio:latest
    container_name: portfolio_web
    restart: unless-stopped
    ports:
      - "80:80"
    environment:
      - RAILS_ENV=production
      # IMPORTANT: Set RAILS_MASTER_KEY in Portainer environment variables
      # Get the value with: cat config/master.key
      # Make sure there are no spaces or newlines when pasting
      - RAILS_MASTER_KEY=${RAILS_MASTER_KEY}
      - RAILS_MAX_THREADS=${RAILS_MAX_THREADS:-5}
      - RAILS_LOG_LEVEL=${RAILS_LOG_LEVEL:-info}
      - PORT=80
      # Enable Solid Queue in Puma for background jobs
      - SOLID_QUEUE_IN_PUMA=true
      # Optional: Configure job concurrency
      # - JOB_CONCURRENCY=1
      # Optional: Configure web concurrency (Puma workers)
      # - WEB_CONCURRENCY=1
    volumes:
      # Persist storage (SQLite databases and uploaded files)
      - portfolio_storage:/rails/storage
      # Persist logs
      - portfolio_logs:/rails/log
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # Resource limits (adjust based on your server)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Optional: Cloudflare Tunnel service
  # Uncomment and configure if you want to run cloudflared in Docker
  # Make sure to set CLOUDFLARE_TUNNEL_TOKEN environment variable in Portainer
  # cloudflared:
  #   image: cloudflare/cloudflared:latest
  #   container_name: portfolio_cloudflared
  #   restart: unless-stopped
  #   command: tunnel run
  #   environment:
  #     - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
  #   depends_on:
  #     - web

volumes:
  portfolio_storage:
    driver: local
  portfolio_logs:
    driver: local

